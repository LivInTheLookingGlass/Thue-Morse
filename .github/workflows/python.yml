name: Python tests

on:
  push:
    paths:
    - 'code/**'
    - '.github/workflows/python.yml'
  schedule:
  - cron: "0 0 1 * *"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Use Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: 3.12
        cache: 'pip'
        cache-dependency-path: requirements.txt

    - name: Fetch test dependencies
      run: python -m pip install -r requirements.txt

    - name: Run Linters
      run: python -m pytest --isort --flake8 --mypy --mypy-ignore-missing-imports -k "not test_compare"

  base_2:
    strategy:
      fail-fast: false
      matrix:
        def: 
        - 2_02
        - 2_03
        - 2_04
        - 2_05
        - 2_06
        - 2_07
        - 2_08
        - 2_09
        - 2_10
        - 2_11
        - 2_12
        - 2_13
        - n_01
        - n_02
        - n_03
        - n_04
        - n_05
        - n_06
    runs-on: ubuntu-latest
    name: Test ${{matrix.def}} in base 2
    steps:
    - uses: actions/checkout@v4

    - name: Use Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: 3.12
        cache: 'pip'
        cache-dependency-path: requirements.txt

    - name: Fetch test dependencies
      run: python -m pip install -r requirements.txt

    - name: Run tests (${{matrix.def}})
      run: |
        ulimit -S -v 14680064; ulimit -H -v; ulimit -S -v
        ulimit -S -m 14680064; ulimit -H -m; ulimit -S -m
        case ${{matrix.def}} in
          2_02)
            test_len=35
            ;;
          2_0[3689]|2_1[01])
            test_len=34
            ;;
          n_01)
            test_len=33
            ;;
          n_0[23]|[2n]_05)
            test_len=32
            ;;
          n_06)
            test_len=31
            ;;
          [2n]_04|2_13)
            test_len=29
            ;;
          2_07)
            test_len=21
            ;;
          2_12)
            test_len=15
            ;;
          *)
            echo "Unknown definition; limit not set"
            exit -1
            ;;
        esac
        sed -i "s/^test_len = .*/test_len = 2**$test_len/" code/test_seq.py
        echo "Testing up to 2^$test_len"

        source .mem_mon.sh
        monitor_memory &
        monitor_pid=$!

        python -m pytest -k "${{matrix.def}}" --timeout=21555

        kill $monitor_pid
        echo "Lowest free memory seen during the pytest run: $min_free_mem MB"

  base_n:
    strategy:
      fail-fast: false
      matrix:
        bases: 
        - 3-16
        - 17-32
        - 33-48
        - 49-64
        - 65-80
        - 81-96
        - 97-112
        - 113-128
        - 129-144
        - 145-160
        - 161-176
        - 177-192
        - 193-208
        - 209-224
        - 225-240
        - 241-255
        def: [2, 3, 4, 5, 6]

    runs-on: ubuntu-latest
    needs: lint
    name: Test n_0${{matrix.def}} for bases ${{matrix.bases}}

    steps:
    - uses: actions/checkout@v4

    - name: Use Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: 3.12
        cache: 'pip'
        cache-dependency-path: requirements.txt

    - name: Fetch test dependencies
      run: python -m pip install -r requirements.txt

    - name: Run tests (${{matrix.def}} ${{matrix.bases}})
      run: |
        ulimit -S -v 14680064; ulimit -H -v; ulimit -S -v
        ulimit -S -m 14680064; ulimit -H -m; ulimit -S -m
        case ${{matrix.def}}-${{matrix.bases}} in
          [234]-*)
            test_len=29
            ;;
          [56]-*)
            test_len=30
            ;;
          *)
            echo "Unknown definition; limit not set"
            exit -1
            ;;
        esac
        IFS='-' read -r start stop <<< "${{matrix.bases}}"
        bases=()
        for (( i=start; i<=stop; i++ )); do
            bases+=("$i")
        done
        base_regex=""
        for (( i=start; i<=stop; i++ )); do
            # Format base as base_XX (ensure it's two digits)
            formatted_base=$(printf "%03d" "$i")
            base_regex+="base_${formatted_base} or "
        done
        base_regex="${base_regex% or }"
        echo "Testing up to 2^$test_len"
        sed -i "s/^test_len = .*/test_len = 2**$test_len/" code/test_seq.py
        echo $base_regex

        source .mem_mon.sh
        monitor_memory &
        monitor_pid=$!

        python -m pytest -k "${{matrix.def}}- and ($base_regex)"

        kill $monitor_pid
        echo "Lowest free memory seen during the pytest run: $min_free_mem MB"
